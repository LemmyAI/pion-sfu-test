<!DOCTYPE html>
<html>
<head>
    <title>Pion SFU Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #1a1a2e; color: #eee; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #videos { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        video { width: 300px; height: 225px; background: #000; border-radius: 8px; }
        .controls { margin: 20px 0; }
        #status { margin: 20px 0; padding: 10px; background: #16213e; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ðŸŽ¥ Pion SFU Test</h1>
    
    <div id="status">Disconnected</div>
    
    <div class="controls">
        <button onclick="connect()">Connect</button>
        <button onclick="publish()">Publish Camera</button>
        <button onclick="subscribe()">Subscribe</button>
    </div>
    
    <div id="videos"></div>

    <script>
        let ws = null;
        let myId = null;
        let publisher = null;
        let subscriber = null;
        
        // Queue ICE candidates until remote description is set
        let publisherIceQueue = [];
        let subscriberIceQueue = [];

        async function processQueuedCandidates(pc, queue) {
            while (queue.length > 0) {
                const candidate = queue.shift();
                try {
                    await pc.addIceCandidate(candidate);
                } catch (e) {
                    console.warn('ICE candidate error:', e);
                }
            }
        }

        async function connect() {
            if (ws) return;
            
            ws = new WebSocket(`wss://${location.host}/ws`);
            
            ws.onmessage = async (e) => {
                const data = JSON.parse(e.data);
                console.log('ðŸ“© Received:', data.type);

                switch (data.type) {
                    case 'welcome':
                        myId = data.id;
                        document.getElementById('status').textContent = `Connected as ${myId}`;
                        break;

                    case 'publish_answer':
                        if (publisher) {
                            await publisher.setRemoteDescription({ type: 'answer', sdp: data.sdp });
                            console.log('âœ… Publisher connected');
                            // Process queued ICE candidates
                            await processQueuedCandidates(publisher, publisherIceQueue);
                        }
                        break;

                    case 'subscribe_offer':
                        if (subscriber) {
                            await subscriber.setRemoteDescription({ type: 'offer', sdp: data.sdp });
                            const answer = await subscriber.createAnswer();
                            await subscriber.setLocalDescription(answer);
                            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
                            console.log('âœ… Subscriber connected');
                            // Process queued ICE candidates
                            await processQueuedCandidates(subscriber, subscriberIceQueue);
                        }
                        break;

                    case 'ice':
                        if (data.target === 'publish') {
                            if (publisher && publisher.remoteDescription) {
                                await publisher.addIceCandidate(data.candidate);
                            } else {
                                publisherIceQueue.push(data.candidate);
                            }
                        } else {
                            if (subscriber && subscriber.remoteDescription) {
                                await subscriber.addIceCandidate(data.candidate);
                            } else {
                                subscriberIceQueue.push(data.candidate);
                            }
                        }
                        break;
                }
            };

            ws.onclose = () => {
                document.getElementById('status').textContent = 'Disconnected';
                ws = null;
            };
            
            console.log('ðŸ”Œ Connecting...');
        }

        async function publish() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Please connect first!');
                return;
            }
            
            publisherIceQueue = [];
            publisher = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            publisher.onicecandidate = (e) => {
                if (e.candidate && ws) {
                    ws.send(JSON.stringify({ type: 'ice', target: 'publish', candidate: e.candidate.toJSON() }));
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            
            const myVideo = document.createElement('video');
            myVideo.srcObject = stream;
            myVideo.muted = true;
            myVideo.autoplay = true;
            document.getElementById('videos').appendChild(myVideo);

            stream.getTracks().forEach(track => {
                publisher.addTrack(track, stream);
            });

            const offer = await publisher.createOffer();
            await publisher.setLocalDescription(offer);
            
            ws.send(JSON.stringify({ type: 'publish', sdp: offer.sdp }));
            console.log('ðŸ“¤ Publisher offer sent');
        }

        async function subscribe() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Please connect first!');
                return;
            }
            
            subscriberIceQueue = [];
            subscriber = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            subscriber.onicecandidate = (e) => {
                if (e.candidate && ws) {
                    ws.send(JSON.stringify({ type: 'ice', target: 'subscribe', candidate: e.candidate.toJSON() }));
                }
            };

            subscriber.ontrack = (e) => {
                console.log('ðŸ“º Received track:', e.track.kind);
                const video = document.createElement('video');
                video.srcObject = e.streams[0];
                video.autoplay = true;
                document.getElementById('videos').appendChild(video);
            };

            ws.send(JSON.stringify({ type: 'subscribe' }));
            console.log('ðŸ“¤ Subscribe request sent');
        }
    </script>
</body>
</html>